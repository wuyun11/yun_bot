# Python 模块代码格式与注释规范

本文总结单个 Python 文件（模块）内常见的代码排列顺序、注释应放的位置，以及「额外用到的函数」如何摆放，便于保持风格统一、便于阅读。

---

## 1. 文件从上到下的常见顺序

建议按以下顺序组织，从上到下阅读时先看到「整体说明 → 依赖 → 内部实现 → 对外接口」：

| 顺序 | 内容 | 说明 |
|------|------|------|
| 1 | **模块 docstring** | 文件最顶部用 `"""..."""` 说明本模块做什么 |
| 2 | **import** | 先标准库、空一行、再第三方/项目内包 |
| 3 | **模块级常量 / 缓存变量** | 全大写常量或 `_xxx` 缓存，可加简短注释 |
| 4 | **辅助 / 内部函数** | 以下划线开头的 `_xxx()`，供本模块内其他函数使用 |
| 5 | **对外接口** | 被 `@tool`、`@router` 等装饰的对外函数，按逻辑分组 |

---

## 2. 注释放在哪里

| 类型 | 位置 | 用途 |
|------|------|------|
| **模块 docstring** | 文件最顶部，`"""..."""`，在 import 之前 | 说明整个文件职责 |
| **函数 docstring** | 紧贴在该函数 `def` 下一行，缩进在函数体内 | 说明该函数作用、参数、返回值（可选） |
| **块注释** | 某一段逻辑的**正上方**，用 `#` 或 `"""..."""` | 说明下面几行在做什么（如「外部数据缓存：仅首次加载」） |
| **行内注释** | 某一行**末尾**，`# 说明` | 只解释这一行，尽量简短 |

**注意**：函数说明应写在**函数内部第一行**的 docstring，不要写在函数外部的「浮空」注释，否则工具（如 `help()`、IDE）会识别为模块级说明而非该函数的说明。

---

## 3. 「额外用到的函数」放什么位置

- **只在本文件内使用的辅助函数**（如 `_load_external_data_by_user_month`）  
  - 放在**调用它的函数上方**。  
  - 命名建议加**单下划线前缀** `_xxx`，表示「内部使用、不对外」。

- **被多个对外函数共用的辅助函数**  
  - 放在**所有对外接口之前**，按「从底层到上层」排列（如先数据加载，再业务工具）。

- **对外接口**（如被 `@tool` 装饰、给 Agent 调用的函数）  
  - 放在**辅助函数之后**，这样阅读时先看到内部实现，再看到对外入口。

---

## 4. 示例结构对照

以 `agent_tools.py` 为例：

```
""" 本模块提供 Agent 可调用的工具函数（RAG、天气、用户/月份、外部数据等）。 """

import csv
import json
...

# 外部数据缓存：仅首次从 CSV 加载，后续复用
_external_data_cache: dict = {}
_external_data_loaded = False

def _load_external_data_by_user_month() -> dict:
    """从 CSV 加载外部数据，构建 user_id -> month -> 记录 的嵌套字典，仅首次加载，后续复用缓存。"""
    ...

@tool(description="...")
def fetch_external_data(user_id: str, month: str) -> str:
    ...
```

- **文件顶**：模块 docstring  
- **import 下方**：模块级变量 + 一行块注释  
- **辅助函数**：函数体内第一行 docstring，位置在对外工具函数之上  
- **对外工具**：排在后面

---

## 5. 一句话小结

- **模块说明**放文件顶；**函数说明**放函数内第一行；**辅助函数**放在使用它的对外函数上面；**模块级变量**可加一行块注释。  
- 按「模块说明 → import → 常量/缓存 → 内部函数 → 对外接口」的顺序写，注释和额外函数的位置就清晰、统一。
